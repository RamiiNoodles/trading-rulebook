<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Rulebook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .variation-card {
            background-color: #374151;
            border: 1px solid #4b5563;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .btn:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #4b5563;
        }
        .btn-secondary:hover {
            background-color: #6b7280;
        }
         .btn-danger {
            background-color: #dc2626;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }
        .tag {
            background-color: #4f46e5;
            color: #e0e7ff;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        /* View/Edit Mode styles */
        body.view-mode [contenteditable="true"] {
            outline: none;
        }
        body.view-mode .edit-only {
            display: none;
        }
        body.edit-mode .view-only {
            display: none;
        }
        [contenteditable="true"] {
            outline: 2px dashed #4f46e5;
            background-color: #374151;
            padding: 2px 4px;
            border-radius: 4px;
        }
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 40;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1.5rem 2rem;
            width: 90%;
            max-width: 500px;
            border: 1px solid #374151;
        }
        .hidden {
            display: none;
        }
        .image-paste-box {
            border: 2px dashed #4b5563;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s ease;
        }
         .image-paste-box:hover, .image-paste-box.paste-active {
            border-color: #4f46e5;
            background-color: #374151;
        }
        /* Image Gallery */
        .image-gallery {
            position: relative;
        }
        .gallery-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            z-index: 10;
        }
        .gallery-arrow:hover {
            background-color: rgba(0,0,0,0.8);
        }
        .gallery-arrow.left { left: 0.5rem; }
        .gallery-arrow.right { right: 0.5rem; }
        .gallery-counter {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 0.25rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            z-index: 10;
        }
        .is-question {
            color: #f59e0b; /* Amber 400 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-12">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-white">My Trading Rulebook</h1>
                <p class="text-lg text-gray-400 mt-2">A dynamic and editable guide for your trading setups.</p>
            </div>
            <div class="flex justify-center items-center flex-wrap gap-x-4 gap-y-4 mt-6">
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-400">View Mode</span>
                    <label for="mode-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="mode-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                     <span class="text-sm font-medium text-gray-400">Edit Mode</span>
                </div>
                 <div class="border-l border-gray-600 h-6"></div>
                 <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-red-400">Shorts</span>
                    <label for="side-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="side-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-red-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                    <span class="text-sm font-medium text-green-400">Longs</span>
                </div>
                 <div class="border-l border-gray-600 h-6"></div>
                 <button id="import-btn" class="btn btn-secondary">Import</button>
                 <button id="export-btn" class="btn btn-secondary">Export</button>
                 <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Trade Windows Column -->
            <section id="trade-windows-section">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Trade Windows</h2>
                    <button id="add-window-btn" class="btn edit-only">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Window
                    </button>
                </div>
                <div id="trade-windows-container"></div>
            </section>

            <!-- Trade Entries Column -->
            <section id="trade-entries-section">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Trade Entries</h2>
                    <button id="add-entry-btn" class="btn edit-only">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Entry
                    </button>
                </div>
                <div id="trade-entries-container"></div>
            </section>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-container"></div>

    <script>
        // --- INITIAL DATA & STATE ---
        let shortTradeWindows = [], longTradeWindows = [];
        let shortTradeEntries = [], longTradeEntries = [];
        let isEditMode = true;
        let currentTradeSide = 'short'; // 'short' or 'long'
        
        const initialShortTradeWindows = [
            {
                id: `w${Date.now()}1`, title: 'FOBO (Failure of Breakout)',
                variations: [
                    { id: `v${Date.now()}1`, desc: 'Highest high, then price breaks a higher low.', trades: ['FOBO V top'], questions: ['Is the break impulsive?'], images: [], currentImageIndex: 0 },
                    { id: `v${Date.now()}2`, desc: 'Lower high, then price breaks a higher low.', trades: ['Tall M', 'Fractal Vtop'], questions: ['Needs purple stoch + down bar.'], images: [], currentImageIndex: 0 },
                    { id: `v${Date.now()}3`, desc: 'Lower high, then price breaks a lower low.', trades: ['1BarJumpin / 2barjumpin'], questions: ['Needs WHITE stoch.'], images: [], currentImageIndex: 0 }
                ]
            },
            { id: `w${Date.now()}2`, title: 'SHORT ROLL - FRACTAL', variations: [ { id: `v${Date.now()}4`, desc: 'A higher high or lower high fractal forms, followed by a strong down move.', trades: ['Fractal Vtop', 'ShortRollVtop'], questions: ['Is the fractal confirmed?'], images: [], currentImageIndex: 0 } ] },
            { id: `w${Date.now()}3`, title: 'SHORT ROLL - LOWEST LOW', variations: [ { id: `v${Date.now()}5`, desc: 'Imperfect: prev low < 20, prev high > 50, current high divergence.', trades: ['Slant M', 'Fractal Vtop'], questions: ['Does divergence appear on multiple indicators?'], images: [], currentImageIndex: 0 } ] },
            { id: `w${Date.now()}4`, title: 'SHORT TREND', variations: [ { id: `v${Date.now()}6`, desc: 'Lowest low and lower high both form below 20 on Stochastics. Lower high must go above EMA.', trades: ['1BarJumpin / 2barjumpin'], questions: ['Is the trend strong on a higher timeframe?'], images: [], currentImageIndex: 0 } ] }
        ];
        const initialShortTradeEntries = [
            { id: `e${Date.now()}1`, title: 'Slant M', desc: 'A bearish reversal pattern where the second peak is lower than the first, showing weakening momentum.', questions: ['Second peak is clearly lower.', 'Entry on break of neckline?'], images: ['https://placehold.co/600x400/1f2937/d1d5db?text=Paste+Chart+Here'], currentImageIndex: 0 },
            { id: `e${Date.now()}2`, title: 'Tall M', desc: 'A bearish reversal pattern where two peaks are at or near the same price level.', questions: ['Two distinct peaks at similar resistance.'], images: ['https://placehold.co/600x400/1f2937/d1d5db?text=Paste+Chart+Here'], currentImageIndex: 0 },
            { id: `e${Date.now()}3`, title: 'Fractal Vtop', desc: 'A sharp reversal pattern identified by a fractal indicator, forming a distinct "V" shape at the top.', questions: ['A valid fractal high must print.'], images: [], currentImageIndex: 0 },
            { id: `e${Date.now()}4`, title: 'ShortRollVtop', desc: 'A continuation pattern within a downtrend, often after a minor pullback.', questions: ['Market must be in an existing downtrend.'], images: [], currentImageIndex: 0 },
            { id: `e${Date.now()}5`, title: 'FOBO V top', desc: 'The specific V-shaped reversal that occurs at the peak of a failed breakout attempt.', questions: ['Price must first attempt to break a prior high?'], images: [], currentImageIndex: 0 },
            { id: `e${Date.now()}6`, title: '1BarJumpin / 2barjumpin', desc: 'A quick entry based on a 1 or 2-bar reversal pattern, often in a trending market.', questions: ['Look for a strong bearish engulfing or pin bar.'], images: [], currentImageIndex: 0 }
        ];

        const initialLongTradeWindows = [
            {
                id: `lw${Date.now()}1`, title: 'FOBO (Failure of Breakdown)',
                variations: [
                    { id: `lv${Date.now()}1`, desc: 'Lowest low, then price breaks a lower high.', trades: ['FOBO V-Bottom'], questions: ['Is the rally impulsive?'], images: [], currentImageIndex: 0 },
                    { id: `lv${Date.now()}2`, desc: 'Higher low, then price breaks a lower high.', trades: ['Tall W', 'Fractal V-Bottom'], questions: ['Needs green stoch + up bar.'], images: [], currentImageIndex: 0 },
                    { id: `lv${Date.now()}3`, desc: 'Higher low, then price breaks a higher high.', trades: ['1BarJumpin / 2barjumpin'], questions: ['Needs specific stoch signal.'], images: [], currentImageIndex: 0 }
                ]
            },
            { id: `lw${Date.now()}2`, title: 'LONG ROLL - FRACTAL', variations: [ { id: `lv${Date.now()}4`, desc: 'A lower low or higher low fractal forms, followed by a strong up move.', trades: ['Fractal V-Bottom', 'LongRollV-Bottom'], questions: ['Is the fractal confirmed?'], images: [], currentImageIndex: 0 } ] },
            { id: `lw${Date.now()}3`, title: 'LONG ROLL - HIGHEST HIGH', variations: [ { id: `lv${Date.now()}5`, desc: 'Imperfect: prev high > 80, prev low < 50, current low divergence.', trades: ['Slant W', 'Fractal V-Bottom'], questions: ['Does divergence appear on multiple indicators?'], images: [], currentImageIndex: 0 } ] },
            { id: `lw${Date.now()}4`, title: 'LONG TREND', variations: [ { id: `lv${Date.now()}6`, desc: 'Highest high and higher low both form above 80 on Stochastics. Higher low must go below EMA.', trades: ['1BarJumpin / 2barjumpin'], questions: ['Is the trend strong on a higher timeframe?'], images: [], currentImageIndex: 0 } ] }
        ];
        const initialLongTradeEntries = [
            { id: `le${Date.now()}1`, title: 'Slant W', desc: 'A bullish reversal pattern where the second low is higher than the first.', questions: ['Second low is clearly higher?', 'Entry on break of neckline.'], images: ['https://placehold.co/600x400/1f2937/d1d5db?text=Paste+Chart+Here'], currentImageIndex: 0 },
            { id: `le${Date.now()}2`, title: 'Tall W', desc: 'A bullish reversal pattern where two lows are at or near the same price level.', questions: ['Two distinct lows at similar support.'], images: ['https://placehold.co/600x400/1f2937/d1d5db?text=Paste+Chart+Here'], currentImageIndex: 0 },
            { id: `le${Date.now()}3`, title: 'Fractal V-Bottom', desc: 'A sharp reversal pattern identified by a fractal indicator, forming a "V" shape at the bottom.', questions: ['A valid fractal low must print.'], images: [], currentImageIndex: 0 },
            { id: `le${Date.now()}4`, title: 'LongRollV-Bottom', desc: 'A continuation pattern within an uptrend, after a minor pullback.', questions: ['Market must be in an existing uptrend?'], images: [], currentImageIndex: 0 },
            { id: `le${Date.now()}5`, title: 'FOBO V-Bottom', desc: 'The V-shaped reversal that occurs at the bottom of a failed breakdown attempt.', questions: ['Price must first attempt to break a prior low.'], images: [], currentImageIndex: 0 },
            { id: `le${Date.now()}6`, title: '1BarJumpin / 2barjumpin', desc: 'A quick entry based on a 1 or 2-bar bullish reversal pattern.', questions: ['Look for a strong bullish engulfing or pin bar.'], images: [], currentImageIndex: 0 }
        ];


        // --- DATA PERSISTENCE ---
        function saveData() {
            const appData = { shortTradeWindows, longTradeWindows, shortTradeEntries, longTradeEntries };
            localStorage.setItem('tradingRulebookData', JSON.stringify(appData));
        }
        
        function processDataObject(dataObject, initialData, isEntry = false) {
             const processItem = (item) => {
                if (isEntry) {
                    if (item.rules && !item.questions) { item.questions = item.rules; delete item.rules; }
                    if (!item.questions) item.questions = [];
                } else {
                     if (!item.variations) item.variations = [];
                     item.variations.forEach(v => {
                        if (!v.images) v.images = [];
                        if (typeof v.currentImageIndex !== 'number') v.currentImageIndex = 0;
                        if (!v.questions) v.questions = [];
                     });
                }
                if (item.img && !item.images) { item.images = [item.img]; delete item.img; }
                if (!item.images) item.images = [];
                if (typeof item.currentImageIndex !== 'number') item.currentImageIndex = 0;
             };
             (dataObject || initialData).forEach(processItem);
             return dataObject || initialData;
        }

        function loadData() {
            const savedData = localStorage.getItem('tradingRulebookData');
            if (savedData) {
                const appData = JSON.parse(savedData);
                if (appData.shortTradeWindows) { // New format
                    shortTradeWindows = processDataObject(appData.shortTradeWindows, initialShortTradeWindows);
                    longTradeWindows = processDataObject(appData.longTradeWindows, initialLongTradeWindows);
                    shortTradeEntries = processDataObject(appData.shortTradeEntries, initialShortTradeEntries, true);
                    longTradeEntries = processDataObject(appData.longTradeEntries, initialLongTradeEntries, true);
                } else { // Old format
                    shortTradeWindows = processDataObject(appData.tradeWindows, initialShortTradeWindows);
                    shortTradeEntries = processDataObject(appData.tradeEntries, initialShortTradeEntries, true);
                    longTradeWindows = initialLongTradeWindows;
                    longTradeEntries = initialLongTradeEntries;
                }
            } else { // No saved data
                shortTradeWindows = initialShortTradeWindows;
                shortTradeEntries = initialShortTradeEntries;
                longTradeWindows = initialLongTradeWindows;
                longTradeEntries = initialLongTradeEntries;
            }
        }

        // --- RENDER FUNCTIONS ---
        const windowsContainer = document.getElementById('trade-windows-container');
        const entriesContainer = document.getElementById('trade-entries-container');

        function createImageGalleryHTML(item, type) {
            const hasImages = item.images && item.images.length > 0;
            const currentImage = hasImages ? item.images[item.currentImageIndex] : 'https://placehold.co/600x400/1f2937/d1d5db?text=Paste+an+image';
            const showArrows = hasImages && item.images.length > 1;
            const dataAttrs = type === 'var' ? `data-win-id="${item.winId}" data-var-id="${item.id}"` : `data-id="${item.id}"`;

            return `
                <div class="image-gallery my-4">
                    <img src="${currentImage}" alt="Chart example" class="rounded-lg w-full h-auto object-cover max-h-72">
                    ${showArrows ? `
                        <button class="gallery-arrow left" data-type="${type}-prev-image" ${dataAttrs}>&lt;</button>
                        <button class="gallery-arrow right" data-type="${type}-next-image" ${dataAttrs}>&gt;</button>
                        <div class="gallery-counter">${item.currentImageIndex + 1} / ${item.images.length}</div>
                    ` : ''}
                </div>
                ${hasImages ? `<button class="btn btn-danger w-full text-xs py-1 px-2 mt-2 edit-only" data-type="${type}-delete-image" ${dataAttrs}>Delete Current Image</button>`: ''}
                <div class="image-paste-box edit-only mt-2" data-type="${type}-paste-box" ${dataAttrs}>
                    Paste Chart Image Here
                </div>
            `;
        }
        
        function createQuestionsHTML(item, type, winId = null) {
            return `
                 <div>
                    <p class="text-sm font-medium text-gray-300 mb-2">Questions / Notes:</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                        ${item.questions.map((q, qIndex) => {
                            const isQuestion = q.includes('?');
                            const dataAttrs = type === 'var' ? `data-win-id="${winId}" data-var-id="${item.id}"` : `data-id="${item.id}"`;
                            return `<li class="flex items-center group">
                                <span class="flex-grow ${isQuestion ? 'is-question' : ''}" contenteditable="${isEditMode}" data-type="${type}-question" ${dataAttrs} data-q-index="${qIndex}">${q}</span>
                                <button class="btn-danger p-1 rounded-md ml-2 opacity-0 group-hover:opacity-100 transition-opacity edit-only" data-type="${type}-delete-question" ${dataAttrs} data-q-index="${qIndex}">
                                     <svg class="w-3 h-3 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </li>`;
                        }).join('')}
                    </ul>
                    <button class="btn btn-secondary mt-2 text-xs py-1 px-2 edit-only" data-type="${type}-add-question" ${type === 'var' ? `data-win-id="${winId}" data-var-id="${item.id}"` : `data-id="${item.id}"`}>+ Add Note</button>
                </div>`;
        }

        function renderTradeWindows(windowsToRender) {
            windowsContainer.innerHTML = '';
            windowsToRender.forEach(window => {
                const windowEl = document.createElement('div');
                windowEl.className = 'card';
                windowEl.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-white w-full" contenteditable="${isEditMode}" data-type="window-title" data-id="${window.id}">${window.title}</h3>
                        <button class="btn-danger p-2 rounded-md ml-2 edit-only" data-type="delete-window" data-id="${window.id}">
                            <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        ${window.variations.map((variation, index) => {
                            variation.winId = window.id; // Pass window id for event handling
                            return `
                            <div class="card variation-card p-4 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold text-indigo-300 w-full" contenteditable="${isEditMode}" data-type="var-desc" data-win-id="${window.id}" data-var-id="${variation.id}">Variation ${index + 1}: ${variation.desc}</h4>
                                    <button class="btn-danger p-2 rounded-md ml-2 edit-only" data-type="delete-variation" data-win-id="${window.id}" data-var-id="${variation.id}">
                                        <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <p class="text-sm font-medium text-gray-300">Applicable Trades:</p>
                                        <button class="btn btn-secondary text-xs py-1 px-2 edit-only" data-type="edit-trades" data-win-id="${window.id}" data-var-id="${variation.id}">Edit</button>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        ${variation.trades.length > 0 ? variation.trades.map(t => `<span class="tag">${t}</span>`).join('') : '<span class="text-sm text-gray-500">None assigned</span>'}
                                    </div>
                                </div>
                                ${createQuestionsHTML(variation, 'var', window.id)}
                                ${createImageGalleryHTML(variation, 'var')}
                            </div>
                        `}).join('')}
                    </div>
                    <button class="btn btn-secondary mt-4 w-full edit-only" data-type="add-variation" data-id="${window.id}">+ Add Variation</button>
                `;
                windowsContainer.appendChild(windowEl);
            });
        }

        function renderTradeEntries(entriesToRender) {
            entriesContainer.innerHTML = '';
            entriesToRender.forEach(entry => {
                const entryEl = document.createElement('div');
                entryEl.className = 'card';
                entryEl.dataset.entryId = entry.id;
                entryEl.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-white w-full" contenteditable="${isEditMode}" data-type="entry-title" data-id="${entry.id}">${entry.title}</h3>
                         <button class="btn-danger p-2 rounded-md ml-2 edit-only" data-type="delete-entry" data-id="${entry.id}">
                             <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <p class="text-gray-400 mb-4" contenteditable="${isEditMode}" data-type="entry-desc" data-id="${entry.id}">${entry.desc}</p>
                    ${createQuestionsHTML(entry, 'entry')}
                    ${createImageGalleryHTML(entry, 'entry')}
                `;
                entriesContainer.appendChild(entryEl);
            });
        }
        
        // --- EVENT HANDLING ---
        document.addEventListener('input', (e) => {
             if (e.target.hasAttribute('contenteditable')) {
                const type = e.target.dataset.type;
                if (type === 'var-question' || type === 'entry-question') {
                    e.target.classList.toggle('is-question', e.target.innerText.includes('?'));
                }
            }
        });

        document.addEventListener('focusout', (e) => {
            if (e.target.hasAttribute('contenteditable')) {
                const windows = (currentTradeSide === 'short') ? shortTradeWindows : longTradeWindows;
                const entries = (currentTradeSide === 'short') ? shortTradeEntries : longTradeEntries;
                const { type, id, winId, varId, qIndex } = e.target.dataset;
                const newText = e.target.innerText;
                
                switch (type) {
                    case 'window-title': windows.find(w => w.id === id).title = newText; break;
                    case 'var-desc': windows.find(w => w.id === winId).variations.find(v => v.id === varId).desc = newText.replace(/Variation \d+: /, ''); break;
                    case 'var-question': windows.find(w => w.id === winId).variations.find(v => v.id === varId).questions[qIndex] = newText; break;
                    case 'entry-title': entries.find(entry => entry.id === id).title = newText; break;
                    case 'entry-desc': entries.find(entry => entry.id === id).desc = newText; break;
                    case 'entry-question': entries.find(e => e.id === id).questions[qIndex] = newText; break;
                }
                saveData();
            }
        });
        
        document.addEventListener('click', (e) => {
            // --- Paste Box UI Logic ---
            const allPasteBoxes = document.querySelectorAll('.image-paste-box');
            const clickedPasteBox = e.target.closest('.image-paste-box');

            allPasteBoxes.forEach(box => {
                if (box !== clickedPasteBox) {
                    box.classList.remove('paste-active');
                    box.innerHTML = 'Paste Chart Image Here';
                }
            });
            
            if (clickedPasteBox) {
                clickedPasteBox.classList.add('paste-active');
                clickedPasteBox.innerHTML = `<strong>Pasting Here...</strong><br><span class="text-xs">Press Ctrl+V or Command+V</span>`;
            }

            // --- Button Logic ---
             const targetButton = e.target.closest('button');
             if (!targetButton) return;

             let windows = (currentTradeSide === 'short') ? shortTradeWindows : longTradeWindows;
             let entries = (currentTradeSide === 'short') ? shortTradeEntries : longTradeEntries;
             const { type, id, winId, varId, qIndex } = targetButton.dataset;

             const performDelete = (delType, data) => {
                let parent, item;
                switch(delType) {
                    case 'delete-window': windows = windows.filter(w => w.id !== data.id); break;
                    case 'delete-variation': windows.find(w => w.id === data.winId).variations = windows.find(w => w.id === data.winId).variations.filter(v => v.id !== data.varId); break;
                    case 'delete-entry': entries = entries.filter(e => e.id !== data.id); break;
                    case 'var-delete-question':
                         parent = windows.find(w => w.id === data.winId).variations.find(v => v.id === data.varId);
                         parent.questions.splice(data.qIndex, 1);
                         break;
                    case 'entry-delete-question':
                        parent = entries.find(e => e.id === data.id);
                        parent.questions.splice(data.qIndex, 1);
                        break;
                    case 'var-delete-image':
                        item = windows.find(w => w.id === data.winId).variations.find(v => v.id === data.varId);
                        if (item && item.images.length > 0) {
                            item.images.splice(item.currentImageIndex, 1);
                            item.currentImageIndex = Math.max(0, item.images.length - 1);
                        }
                        break;
                    case 'entry-delete-image':
                         item = entries.find(e => e.id === data.id);
                         if (item && item.images.length > 0) {
                            item.images.splice(item.currentImageIndex, 1);
                            item.currentImageIndex = Math.max(0, item.images.length - 1);
                        }
                        break;
                }
                
                if (currentTradeSide === 'short') { shortTradeWindows = windows; shortTradeEntries = entries; } 
                else { longTradeWindows = windows; longTradeEntries = entries; }
                saveData(); renderAll();
             }
             
             let item;
             switch(type) {
                case 'add-variation': windows.find(w => w.id === id).variations.push({ id: `v${Date.now()}`, desc: 'New Variation', trades: [], questions: [], images: [], currentImageIndex: 0 }); break;
                case 'var-add-question': windows.find(w => w.id === winId).variations.find(v => v.id === varId).questions.push('New Note'); break;
                case 'entry-add-question': entries.find(e => e.id === id).questions.push('New Note'); break;
                case 'var-prev-image': item = windows.find(w => w.id === winId).variations.find(v => v.id === varId); item.currentImageIndex = (item.currentImageIndex - 1 + item.images.length) % item.images.length; break;
                case 'var-next-image': item = windows.find(w => w.id === winId).variations.find(v => v.id === varId); item.currentImageIndex = (item.currentImageIndex + 1) % item.images.length; break;
                case 'entry-prev-image': item = entries.find(e => e.id === id); item.currentImageIndex = (item.currentImageIndex - 1 + item.images.length) % item.images.length; break;
                case 'entry-next-image': item = entries.find(e => e.id === id); item.currentImageIndex = (item.currentImageIndex + 1) % item.images.length; break;
                
                case 'delete-window': case 'delete-variation': case 'delete-entry':
                case 'var-delete-question': case 'entry-delete-question':
                case 'var-delete-image': case 'entry-delete-image':
                    openConfirmationModal('Are you sure you want to delete this item? It cannot be undone.', () => performDelete(type, {id, winId, varId, qIndex}));
                    return;
                case 'edit-trades': openTradesModal(winId, varId); return;
             }
             saveData();
             renderAll();
        });
        
        document.getElementById('add-window-btn').addEventListener('click', () => {
            const idPrefix = currentTradeSide === 'short' ? '' : 'l';
            const windows = (currentTradeSide === 'short') ? shortTradeWindows : longTradeWindows;
            windows.push({ id: `${idPrefix}w${Date.now()}`, title: 'New Trade Window', variations: [{ id: `${idPrefix}v${Date.now()}`, desc: 'New Variation', trades: [], questions: [], images: [], currentImageIndex: 0 }] });
            saveData();
            renderAll();
        });

        document.getElementById('add-entry-btn').addEventListener('click', () => {
            const idPrefix = currentTradeSide === 'short' ? '' : 'l';
            const entries = (currentTradeSide === 'short') ? shortTradeEntries : longTradeEntries;
            entries.push({ id: `${idPrefix}e${Date.now()}`, title: 'New Trade Entry', desc: 'A description for this trade.', questions: [], images: [], currentImageIndex: 0 });
            saveData();
            renderAll();
        });

        // --- IMAGE PASTING ---
        document.addEventListener('paste', e => {
            const activePasteBox = document.querySelector('.image-paste-box.paste-active');
            if (!activePasteBox || !isEditMode) return;
            
            const { type, id, winId, varId } = activePasteBox.dataset;
            let item;

            if (type === 'entry-paste-box') {
                item = (currentTradeSide === 'short' ? shortTradeEntries : longTradeEntries).find(e => e.id === id);
            } else if (type === 'var-paste-box') {
                item = (currentTradeSide === 'short' ? shortTradeWindows : longTradeWindows).find(w => w.id === winId).variations.find(v => v.id === varId);
            }

            if (!item) return;
            e.preventDefault();

            const file = e.clipboardData.files[0];
            if (!file || file.type.indexOf("image") === -1) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                if (!item.images) item.images = [];
                item.images.push(event.target.result);
                item.currentImageIndex = item.images.length - 1;
                saveData();
                renderAll();
            };
            reader.readAsDataURL(file);
        });

        // --- TOGGLES ---
        document.getElementById('mode-toggle').addEventListener('change', (e) => {
            isEditMode = e.target.checked;
            document.body.classList.toggle('view-mode', !isEditMode);
            document.body.classList.toggle('edit-mode', isEditMode);
            renderAll();
        });

        document.getElementById('side-toggle').addEventListener('change', (e) => {
            currentTradeSide = e.target.checked ? 'long' : 'short';
            renderAll();
        });
        
        // --- MODALS (GENERIC) ---
        const modalContainer = document.getElementById('modal-container');

        function openModal(innerHTML) { modalContainer.innerHTML = innerHTML; }
        function closeModal() { modalContainer.innerHTML = ''; }

        function openConfirmationModal(message, onConfirm) {
            openModal(`
                <div class="modal-backdrop"></div>
                <div class="modal">
                    <p class="text-white text-lg mb-6">${message}</p>
                    <div class="flex justify-end space-x-2">
                        <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
                        <button id="modal-confirm" class="btn btn-danger">Confirm Delete</button>
                    </div>
                </div>
            `);
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-confirm').onclick = () => { onConfirm(); closeModal(); };
        }

        function openTradesModal(winId, varId) {
            const windows = (currentTradeSide === 'short') ? shortTradeWindows : longTradeWindows;
            const entries = (currentTradeSide === 'short') ? shortTradeEntries : longTradeEntries;
            const win = windows.find(w => w.id === winId);
            const variation = win.variations.find(v => v.id === varId);
            const tradesCheckboxes = entries.map(entry => {
                const isChecked = variation.trades.includes(entry.title);
                return `<label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700 cursor-pointer"><input type="checkbox" value="${entry.title}" ${isChecked ? 'checked' : ''} class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500"><span>${entry.title}</span></label>`;
            }).join('');
            openModal(`
                <div class="modal-backdrop"></div>
                <div class="modal">
                    <h3 class="text-xl font-bold text-white mb-4">Select Applicable Trades</h3>
                    <div class="space-y-2 max-h-60 overflow-y-auto mb-6">${tradesCheckboxes}</div>
                    <div class="flex justify-end space-x-2">
                        <button id="modal-cancel-trades" class="btn btn-secondary">Cancel</button>
                        <button id="modal-save-trades" class="btn">Save Changes</button>
                    </div>
                </div>
            `);
            document.getElementById('modal-cancel-trades').onclick = closeModal;
            document.getElementById('modal-save-trades').onclick = () => {
                const selectedTrades = Array.from(modalContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                variation.trades = selectedTrades;
                saveData(); 
                renderAll();
                closeModal();
            };
        }
        
        // --- IMPORT / EXPORT ---
        document.getElementById('export-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify({ shortTradeWindows, longTradeWindows, shortTradeEntries, longTradeEntries }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url; a.download = 'trading-rulebook.json';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
        
        document.getElementById('import-file-input').addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.shortTradeWindows || importedData.tradeWindows) {
                         localStorage.setItem('tradingRulebookData', e.target.result);
                         loadData(); renderAll();
                    } else { alert('Invalid file format.'); }
                } catch (err) { alert('Error reading file.'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        // --- INITIAL RENDER ---
        function renderAll() {
            if (currentTradeSide === 'short') {
                renderTradeWindows(shortTradeWindows);
                renderTradeEntries(shortTradeEntries);
            } else {
                renderTradeWindows(longTradeWindows);
                renderTradeEntries(longTradeEntries);
            }
        }
        
        loadData();
        document.getElementById('mode-toggle').checked = isEditMode;
        document.body.classList.toggle('view-mode', !isEditMode);
        document.body.classList.toggle('edit-mode', isEditMode);
        renderAll();

    </script>
</body>
</html>

